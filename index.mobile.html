<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>meBird</title>
    <style type="text/css">
        .centerbox {
            margin: 0 auto;
            text-align: center;
        }
        .copyright {
            font-size: 0.75em;
        }
        a[href^="http://"]:after, a[href^="https://"]:after {
          content: url(http://upload.wikimedia.org/wikipedia/commons/6/64/Icon_External_Link.png);
          margin: 0 0 0 5px;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="script.tablesorter/styles.tablesorter.css">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="script.tablesorter/jquery.tablesorter.min.js"></script>
    <script src="script.custom/jquery.custom.mobile.js"></script>
    <!-- jQM -->
    <link rel="stylesheet" href="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <!-- end jQM -->
    <script>
        //var urlBase = "http://huntsebirds.appspot.com/";
        var urlBase = "http://localhost:8080/mebird/";
        var dataFile = "ebird_api_ref_list_test.xml";
        var noDataFound = "<p>No species sightings found.</p>";

        (function( $ ) {
            $(function() { // On document ready
                $(document).on("ajaxSend", function() {
                    var $this = $( this ),
                        theme = $this.jqmData( "theme" ) || $.mobile.loader.prototype.options.theme,
                        msgText = $this.jqmData( "msgtext" ) || $.mobile.loader.prototype.options.text,
                        textVisible = $this.jqmData( "textvisible" ) || $.mobile.loader.prototype.options.textVisible,
                        textonly = !!$this.jqmData( "textonly" );
                        html = $this.jqmData( "html" ) || "";
                    $.mobile.loading( "show", {
                            text: "loading",
                            textVisible: true,
                            theme: theme,
                            textonly: textonly,
                            html: html
                    });
                })
                .on("ajaxStop", function() {
                    $.mobile.loading( "hide" );
                });
            });
            
            var selectedData = { region: "", locId: "", locName: "", sciName: "", comName: "" }

            // Load autocomplete values & handle selection.
            $(document).on("pagecreate", "div[data-role=page]", function(event, ui) {
                var page = $(this).attr("id");
                if (page == "checklists" || page == "notables") {
                    var xml = $.getValues(urlBase + dataFile, "xml");
                    var filteredList = $(xml).filterNode("region");
                    
                    var tags = (page == "checklists") ? "#autocomplete-items-checklists" : "#autocomplete-items-notables";
                    
                    $(tags).on("filterablebeforefilter", function ( e, data ) {
                        var $ul = $( this ),
                            $input = $( data.input ),
                            value = $input.val(),
                            html = "";
                        $ul.html( "" );
                
                        if (value && value.length > 1) {
                            $ul.html( "<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" );
                            $ul.listview( "refresh" );
                
                            var val;
                            $(filteredList).each(function () {
                                val = $(this).filterNode("name").text() + " (" + ($(this).filterNode("subnational2-code").text() || $(this).filterNode("subnational1-code").text()) + ")"
                                html += "<li><a href='#sightings' class='gotoRegion'>" + val + "</a></li>";
                            });
                            
                            $ul.html( html );
                            $ul.listview("refresh");
                            $ul.trigger("updatelayout");
                        }
                    });
                }
            });

            // Save selected region from autocomplete.
            $(document).on("click", "a.gotoRegion", function() {
                selectedData.region = $(this).text();
            });
            
            $(document).pagecontainer({ beforeshow: function(event, ui) { } });
            // Load results data.
            $(document).on("pagecontainerbeforeshow", function(event, ui){
                var toPage = ui.toPage[0].id;
                var prevPage = ui.prevPage.attr('id');
                
                if (toPage == "sightings") {
                    var region = selectedData.region;
                    
                    if (region.length > 0) {
                        var table = "";
                        var message = "";
                        var tableName = "";
                        var data = "";
                        $("#sightings #message").html("");
                        $("#sightings #results").html("");
                    
                        if (prevPage == "notables") {
                            var storedData = sessionStorage.getItem("notablesResults");
                            var storedRegion = sessionStorage.getItem("notablesRegion");
                            if ((storedData != null && storedRegion != null) && storedRegion == selectedData.region) {
                                data = JSON.parse(storedData);
                            } else {
                                var url = $.geteBirdApiUrl(region, "notables");
                                data = $.getValues(url, "json");

                                var storedData = JSON.stringify(data);
                                sessionStorage.setItem("notablesResults", storedData);
                                sessionStorage.setItem("notablesRegion", selectedData.region);
                            }
                            if (data.length > 0) {
                                table = $.getNotablesTable(data, region);
                                message = "<p>Notable species for " + region + ", in last 5 days: " + data.length + ".</p>";
                            } else {
                                message = noDataFound;
                            }
                        }
                        if (prevPage == "checklists") {
                            var storedData = sessionStorage.getItem("checklistsResults");
                            var storedRegion = sessionStorage.getItem("checklistsRegion");
                            if ((storedData != null && storedRegion != null) && storedRegion == selectedData.region) {
                                data = JSON.parse(storedData);
                            } else {
                                var url = $.geteBirdApiUrl(region, "checklists");
                                data = $.getValues(url, "json");

                                var storedData = JSON.stringify(data);
                                sessionStorage.setItem("checklistsResults", storedData);
                                sessionStorage.setItem("checklistsRegion", selectedData.region);
                            }
                            if (data.length > 0) {
                                table = $.getChecklistsTable(data, region);
                                message = "<p>Checklists with number of species seen most recently in " + region + ", in last 5 days: " + (table.rows.length-1) + ".</p>";
                            } else {
                                message = noDataFound;
                            }
                        }
                        if (table != "" && table.rows.length > 1) {
                            $("#sightings #message").html(message);
                            $("#sightings #results").html(table);
                            $("#sightingsTable").tablesorter();
                            $("#sightingsTable").table();
                        }
                    } else {
                        $("#sightings #message").html("<p><a href='#nav-panel-sightings'>Select</a> from Checklists or Notables to search State or County sightings.</p>");
                    }
                }
                if (toPage == "location") {
                    var locId = selectedData.locId;
                    var locName = selectedData.locName;
                    var region = selectedData.region;
                    
                    /*console.log("gotoLocation, locId: " + locId);
                    console.log("gotoLocation, locName: " + locName);
                    console.log("gotoLocation, region : " + region);*/
                    
                    var url = $.geteBirdApiUrl(locId, "location");
                    var data = $.getValues(url, "json");
                    
                    if (data.length > 0) {
                        var table = $.getLocationTable(data);
                        
                        $("#location #results").html(table);
                        $("#location #message").html('<p>Sightings at <a href="http://ebird.org/ebird/hotspot/' + locId + '" target="_blank">' + locName + '</a> in last 14 days: ' + data.length + ".</p>");
                        $("#locationTable").tablesorter();
                        $("#locationTable").table();
                    } else {
                        $("#location #results").html("");
                        $("#location #message").html(noDataFound);
                    }
                }
                if (toPage == "species") {
                    var sciName = selectedData.sciName;
                    var comName = selectedData.comName;
                    var region = selectedData.region;

                    /*console.log("toPage species, sciName: " + sciName);
                    console.log("toPage species, comName: _" + comName + "_");
                    console.log("toPage species, region : " + region);*/
                    
                    var url = $.geteBirdSpeciesApiUrl(sciName, region, "species");
                    var data = $.getValues(url, "json");
                    
                    if (data.length > 0) {
                        var table = $.getSpeciesTable(data, region);

                        $("#species #results").html(table);
                        $("#species #message").html("<p>Sightings of <strong>" + comName + "</strong> in " + region + " in last 14 days: " + data.length + ".</p>");
                        $("#speciesTable").tablesorter();
                        $("#speciesTable").table();
                    } else {
                        $("#species #results").html("");
                        $("#species #message").html(noDataFound);
                    }
                }
            });

            // Load location data.
            $(document).on("click", "a.gotoLocation", function() {
                var locId = $(this).attr('title');
                var locName = $(this).text();
                selectedData.locId = locId;
                selectedData.locName = locName;
            });
        
            // Load species data.
            $(document).on("click", "a.gotoSpecies", function() {
                var title = $(this).attr('title');
                var sciName = $.getSubRegionFromSelection(title);
                var comName = title.substring(0, title.indexOf('(')-1);
                selectedData.sciName = sciName;
                selectedData.comName = comName;
            });
        })( jQuery );
    </script>
</head>
<body>
    <!-- Home -->
    <div data-role="page" id="home" data-title="home">
        <div data-role="header" data-id="site-header" data-position="inline">
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div role="main" class="iu-content">
            <ul data-role="listview"><li><a id="gotoChecklists" href="#checklists">checklists</a></li>
            <li><a id="gotoNotables" href="#notables">notables</a></li></ul>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <!--<a href="#copyright" data-rel="popup" data-transition="pop">copyright</a><a href="#donate">donate</a><a href="#providers">providers</a>--><!--<div data-role="popup" id="copyright">-->
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
    <!-- Checklists Search -->
    <div data-role="page" id="checklists" data-title="mebd | checklists">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-checklists" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <!-- Autocomplete -->
            <form class="ui-filterable"><input id="autocomplete-input-checklists" data-type="search" placeholder="Search for State or County" autofocus="autofocus"></form>
            <ul id="autocomplete-items-checklists" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input-checklists"></ul>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-checklists" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#checklists" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists" class="ui-btn ui-btn-active">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
    <!-- Notables Search -->
    <div data-role="page" id="notables" data-title="mebd | notables">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-notables" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div data-role="main" class="ui-content">
            <!-- Autocomplete -->
            <form class="ui-filterable"><input id="autocomplete-input-notables" data-type="search" placeholder="Search for State or County" autofocus="autofocus"></form>
            <ul id="autocomplete-items-notables" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input-notables"></ul>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-notables" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#notables" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables" class="ui-btn ui-btn-active">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
    <!-- Sightings Results -->
    <div data-role="page" id="sightings" data-title="mebd | sightings">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-sightings" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-sightings" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#sightings" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
    <!-- Location Results -->
    <div data-role="page" id="location" data-title="mebd | location">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-location" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-location" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#location" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
    <!-- Species Results -->
    <div data-role="page" id="species" data-title="mebd | species">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-species" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.mobile.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-species" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#species" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" data-position="fixed" class="centerbox">
            <p class="copyright">Copyright M. Hunt, 2015. All rights reserved. All data courtesy of <a href="http://www.ebird.org" target="_blank">eBird</a></p>
        </div>
    </div>
</body>
</html>
