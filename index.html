<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hunt's eBirds</title>
    <link rel="stylesheet" type="text/css" href="script.tablesorter/styles.tablesorter.css">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="script.tablesorter/jquery.tablesorter.min.js"></script>
    <script src="script.custom/jquery.custom.mobile.js"></script>
    <!-- jQM -->
    <link rel="stylesheet" href="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="//code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <!-- end jQM -->
    <link rel="stylesheet" type="text/css" href="style.custom/styles.custom.css">
    <script>
        //var urlBase = "http://huntsebirds.appspot.com/";
        var urlBase = "http://localhost:8080/mebird/";
        var dataFile = "ebird_api_ref_list_test.xml";
        var noSpeciesDataFound = "No species sightings found.";
        var noLocationDataFound = "No location sightings found.";
        var noNotableDataFound = "No notable sightings found.";
        var noSubmissionsDataFound = "No checklist submissions found.";

        (function( $ ) {
            $(function() { // On document ready
                $(document).on("ajaxSend", function() {
                    var $this = $( this ),
                        theme = $this.jqmData( "theme" ) || $.mobile.loader.prototype.options.theme,
                        msgText = $this.jqmData( "msgtext" ) || $.mobile.loader.prototype.options.text,
                        textVisible = $this.jqmData( "textvisible" ) || $.mobile.loader.prototype.options.textVisible,
                        textonly = !!$this.jqmData( "textonly" );
                        html = $this.jqmData( "html" ) || "";
                    $.mobile.loading( "show", {
                            text: "loading",
                            textVisible: true,
                            theme: theme,
                            textonly: textonly,
                            html: html
                    });
                })
                .on("ajaxStop", function() {
                    $.mobile.loading( "hide" );
                });
            });
            
            var selectedData = { region: "", locId: "", locName: "", sciName: "", comName: "", startPage: "" }

            // Load autocomplete values & handle selection.
            $(document).on("pagecreate", "div[data-role=page]", function(event, ui) {
                var page = $(this).attr("id");
                
                console.log("pagecreate: "+page);
                
                if (page == "checklists" || page == "notables") {
                    var xml = $.getValues(urlBase + dataFile, "xml");
                    var filteredList = $(xml).filterNode("region");
                    
                    var tags = (page == "checklists") ? "#autocomplete-items-checklists" : "#autocomplete-items-notables";
                    var href = (page == "checklists") ? "#submissions" : "#sightings";
                    
                    $(tags).on("filterablebeforefilter", function ( e, data ) {
                        var $ul = $( this ),
                            $input = $( data.input ),
                            value = $input.val(),
                            html = "";
                        $ul.html( "" );
                
                        if (value && value.length > 1) {
                            $ul.html( "<li><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" );
                            $ul.listview( "refresh" );
                
                            var val;
                            $(filteredList).each(function () {
                                val = $(this).filterNode("name").text() + " (" + ($(this).filterNode("subnational2-code").text() || $(this).filterNode("subnational1-code").text()) + ")"
                                html += "<li><a href='" + href + "' class='gotoRegion'>" + val + "</a></li>";
                            });
                            
                            $ul.html( html );
                            $ul.listview("refresh");
                            $ul.trigger("updatelayout");
                        }
                    });
                }
            });

            // Save selected region from autocomplete.
            $(document).on("click", "a.gotoRegion", function() {
                selectedData.region = $(this).text();
            });
            
            $(document).pagecontainer({ beforeshow: function(event, ui) { } });
            // Load results data.
            $(document).on("pagecontainerbeforeshow", function(event, ui){
                var toPage = ui.toPage[0].id;
                var prevPage = ui.prevPage.attr('id');
                var table = "";
                var message = "";
                var tableName = "";
                var data = "";
                var page = "";
                
                console.log("pagecontainerbeforeshow: " + toPage);
                
                if (toPage == "submissions") {
                    page = "#submissions";
                    var region = selectedData.region;
                    if (region.length > 0) {
                        tableName = "#submissionsTable";
                        //console.log('get checklists: ' + prevPage + ", " + selectedData.startPage);
                        data = $.getData("checklistsResults", "checklistsRegion", region, "checklists");

                        if (data.length > 0) {
                            table = $.getChecklistsTable(data, region);
                            message = "Checklists with number of species seen most recently in " + region + ", in last 5 days: " + (table.rows.length-1) + ".";
                        } else {
                            message = noSubmissionsDataFound;
                        }
                    } else {
                        $(page + " #message").html("<a href='#nav-panel-checklist-sightings'>Select</a> from Checklists or Notables to search State or County sightings.");
                    }
                }
                if (toPage == "sightings") {
                    page = "#sightings";
                    var region = selectedData.region;
                    if (region.length > 0) {
                        tableName = "#sightingsTable";
                        //console.log('getData: ' + prevPage + ", " + selectedData.startPage);
                        data = $.getData("notablesResults", "notablesRegion", region, "notables");
                        if (data.length > 0) {
                            table = $.getNotablesTable(data, region);
                            message = "Notable species for " + region + ", in last 5 days: " + data.length + ".";
                        } else {
                            message = noNotableDataFound;
                        }
                    } else {
                        $(page + " #message").html("<a href='#nav-panel-notable-sightings'>Select</a> from Checklists or Notables to search State or County sightings.");
                    }
                }
                if (toPage == "location") {
                    page = "#location";
                    var locId = selectedData.locId;
                    var locName = selectedData.locName;
                    var region = selectedData.region;
                    
                    var url = $.geteBirdApiUrl(locId, "location");
                    var data = $.getValues(url, "json");
                    
                    if (data.length > 0) {
                        table = $.getLocationTable(data);
                        message = 'Sightings at <a href="http://ebird.org/ebird/hotspot/' + locId + '" target="_blank">' + locName + '</a> in last 14 days: ' + data.length + '.';
                    } else {
                        message = noLocationDataFound;
                    }
                }
                if (toPage == "species") {
                    page = "#species";

                    console.log("selectedData: " + JSON.stringify(selectedData));
                    console.log("sessionStorage: " + JSON.stringify(sessionStorage.getItem("identification")));
                    
                    if (selectedData.comName == "") {
                        // Populate from session, passed back from identify page.
                        console.log("get data FROM identify page");
                        selectedData = JSON.parse(sessionStorage.getItem("identification"));
                    } else {
                        console.log("store data FOR identify page: " + JSON.stringify(selectedData));
                        sessionStorage.setItem("identification", JSON.stringify(selectedData));
                    }

                    var sciName = selectedData.sciName;
                    var comName = selectedData.comName;
                    var region = selectedData.region;

                    if (sciName != "") {
                        var url = $.geteBirdSpeciesApiUrl(sciName, region, "species");
                        var data = $.getValues(url, "json");
                        
                        if (data.length > 0) {
                            table = $.getSpeciesTable(data, region);
                            message = 'Sightings of <a href="identify.html" rel="external" data-ajax="false">' + comName + '</a> in ' + region + ' in last 14 days: ' + data.length + '.';
                        } else {
                             message = noSpeciesDataFound;
                        }
                    } else {
                         message = noSpeciesDataFound;
                    }
                }
                if (table != "" && table.rows.length > 1) {
                    $(page + " #message").html(message);
                    $(page + " #results").html(table);
                    //$(tableName).tablesorter();
                    //$(tableName).table();
                } else if (message != "") {
                    $(page + " #message").html(message);
                    $(page + " #results").html("");
                }
            });

            // Load location data.
            $(document).on("click", "a.gotoLocation", function() {
                var locId = $(this).attr('title');
                var locName = $(this).text();
                selectedData.locId = locId;
                selectedData.locName = locName;
            });
        
            // Load species data.
            $(document).on("click", "a.gotoSpecies", function() {
                var title = $(this).attr('title');
                var sciName = $.getSubRegionFromSelection(title);
                var comName = title.substring(0, title.indexOf('(')-1);
                selectedData.sciName = sciName;
                selectedData.comName = comName;
            });
        })( jQuery );
    </script>
</head>
<body>
    <!-- Home -->
    <div data-role="page" id="home" data-title="home">
        <div data-role="header" data-id="site-header" data-position="inline">
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="iu-content">
            <ul data-role="listview"><li><a id="gotoChecklists" href="#checklists">checklists</a></li>
            <li><a id="gotoNotables" href="#notables">notables</a></li></ul>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Checklists Search -->
    <div data-role="page" id="checklists" data-title="hunt's ebirds | checklists">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-checklists" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <!-- Autocomplete -->
            <form class="ui-filterable"><input id="autocomplete-input-checklists" data-type="search" placeholder="Search for State or County" autofocus="autofocus"></form>
            <ul id="autocomplete-items-checklists" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input-checklists"></ul>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-checklists" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#checklists" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists" class="ui-btn ui-btn-active">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Checklists Submissions Results -->
    <div data-role="page" id="submissions" data-title="hunt's ebirds | sightings">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-checklist-sightings" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <br />
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-checklist-sightings" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#submissions" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Notables Search -->
    <div data-role="page" id="notables" data-title="hunt's ebirds | notables">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-notables" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div data-role="main" class="ui-content">
            <!-- Autocomplete -->
            <form class="ui-filterable"><input id="autocomplete-input-notables" data-type="search" placeholder="Search for State or County" autofocus="autofocus"></form>
            <ul id="autocomplete-items-notables" data-role="listview" data-inset="true" data-filter="true" data-input="#autocomplete-input-notables"></ul>
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-notables" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#notables" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables" class="ui-btn ui-btn-active">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Notable Sightings Results -->
    <div data-role="page" id="sightings" data-title="hunt's ebirds | sightings">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-notable-sightings" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <br />
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-notable-sightings" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#sightings" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Location Results -->
    <div data-role="page" id="location" data-title="hunt's ebirds | location">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-location" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <br />
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-location" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#location" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Species Results -->
    <div data-role="page" id="species" data-title="hunt's ebirds | species">
        <div data-role="header" data-id="site-header">
            <a href="#nav-panel-species" data-icon="bars" data-iconpos="notext">Menu</a>
            <h1><a href="index.html">home</a></h1>
        </div>
        <div role="main" class="ui-content">
            <div id="message"></div>
            <div id="results"></div>
            <br />
            <!-- Nav Panel -->
            <div data-role="panel" id="nav-panel-species" data-display="overlay" data-position="left">
                <ul data-role="listview">
                <li><a href="#species" data-rel="close" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">close</a>
                <li><a href="#checklists" id="gotoChecklists">checklists</a></li>
                <li><a href="#notables" id="gotoNotables">notables</a></li>
                </ul>
            </div>
        </div>
        <div data-role="footer" class="centerbox">
            <p class="copyright">&copy 2015 M Hunt. Data by <a href="http://www.ebird.org" target="_blank">eBird</a>
        </div>
    </div>
    <!-- Donate -> separate page -->
    <!-- Providers -> separate page -->
</body>
</html>
